<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="icon" type="image/png" href="favicon.png">
    <title>ГосЗатраты Визуализация</title>

    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.css' rel='stylesheet' />
    <link href="open-iconic/font/css/open-iconic.css" rel="stylesheet">
    <link rel="stylesheet" href="main.css"/>
</head>
<body>
    <div id="map"></div>
    <div id="yearLabel"></div>

    <div id="info" style="display:none">
        <div>
            Визуализация распределения бюджетных средств на основе данных с <a href="//clearspending.ru" target="_blank">ГосЗатраты</a>.<br />
            Данные по координатам объектов взяты с <a href="//maps.yandex.ru" target="_blank">Яндекс.Карты</a>
        </div>
        <hr>
        Powered by <a href="http://d3js.org" target="_blank">D3js</a>, <a href="http://mapbox.com" target="_blank">MapBox</a>, <a href="http://github.com/artzub/blackhole.js" target="_blank">BlackHole.js</a><br/>
        Icons from the <a href="https://useiconic.com/open" target="_blank">OPEN ICONIC</a><br/>
        © 2014 <a href="http://artzub.com" target="_blank">Artem Zubkov (ArtZub)</a>, <a target="_blank" href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>.<br />
    </div>

    <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v0.0.2/Leaflet.fullscreen.min.js'></script>
    <link href='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v0.0.2/leaflet.fullscreen.css' rel='stylesheet' />

    <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-heat/v0.1.0/leaflet-heat.js'></script>

    <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js'></script>
    <link href='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.css' rel='stylesheet' />
    <link href='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.Default.css' rel='stylesheet' />

    <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.24.0/L.Control.Locate.js'></script>
    <link href='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.24.0/L.Control.Locate.css' rel='stylesheet' />
    <!--[if lt IE 9]>
    <link href='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.21.0/L.Control.Locate.ie.css' rel='stylesheet' />
    <![endif]-->

    <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.24.0/L.Control.Locate.js'></script>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="http://lib.artzub.com/js/blackhole.js/js/blackhole.js"></script>
    <script src="http://lib.artzub.com/js/blackhole.js/js/blackhole.legend.js"></script>
    <script src="js/L.BlackHoleLayer.js"></script>
    <script src="js/L.Control.ActionConsole.js"></script>
    <script src="js/L.Control.ResetZoom.js"></script>
    <script src="js/L.CategoriesLayer.js"></script>
    <!--<script src="//rawgit.com/artzub/blackhole.js/master/js/blackhole.js"></script>-->

    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-28343295-12', 'artzub.com');
        ga('send', 'pageview');

        var info = d3.select('#info').html()
            , yearLabel = d3.select("#yearLabel")
            ;


        var map = L.mapbox.map('map', 'artzub.hp68ld67', {
                zoomControl : false
            }).whenReady(handleReady)
            , visLayer = L.blackHoleLayer()
            ;

        function fixInfo() {
            map.infoControl._info = {};
            map.infoControl.addInfo(info);
        }

        function handleReady() {

            map.zoomControl = L.control.zoom({
                position: 'bottomright',
                zoomInTitle: 'Приблизить',
                zoomOutTitle: 'Отдалить'
            }).addTo(map);

            L.control.resetZoom({
                position: 'bottomright',
                strings : {
                    reset : 'Переключить вид'
                }
            }).addTo(map);

            map.on('moveend', fixInfo)
                .on('layeradd', fixInfo)
                .on('layerremove', fixInfo);

            map.on('layeradd', function() {
                console.log(arguments);
            });

            //window.hashContracts = {};
            window.hashSuppliers = {};
            window.hashCustomers = {};
            var data = []
                , stepDate = 24 * 60 * 60 * 1000
                , sizes = d3.scale.linear().range([4, 400])
            ;


            function Supplier(d) {
                var that = hashSuppliers[d._id] = this;

                that._id = d._id;
                that.name = d.name;
                that.latlng = new L.LatLng(d.latlng[0], d.latlng[1]);
                that.address = d.address;

                that.x = {
                    valueOf: function () {
                        var t = visLayer._map.latLngToLayerPoint(that.latlng);
                        return t.x;
                    }
                };

                that.y = {
                    valueOf: function () {
                        var t = visLayer._map.latLngToLayerPoint(that.latlng);
                        return t.y;
                    }
                };

                return that;
            }

            function Customer(d) {
                var that = hashCustomers[d._id] = this;

                that._id = d._id;
                that.name = d.name;
                that.latlng = new L.LatLng(d.latlng[0], d.latlng[1]);
                that.address = d.address;

                that.x = {
                    valueOf: function () {
                        var t = visLayer._map.latLngToLayerPoint(that.latlng);
                        return t.x;
                    }
                };

                that.y = {
                    valueOf: function () {
                        var t = visLayer._map.latLngToLayerPoint(that.latlng);
                        return t.y;
                    }
                };

                return that;
            }

            function parseData(d) {

                d.contracts.forEach(function(k, index) {

                    if (!d.suppliers[k.s].latlng
                        || !d.suppliers[k.s].latlng.length
                        || !d.customers[k.c]
                        || !d.customers[k.c].latlng.length)
                        return;

                    var s
                        , cs
                        ;
                    var signDate = +(new Date(k.sd))
                        , protokolDate = k.prd ? +(new Date(k.prd)) : signDate - stepDate
                        , publishDate = k.pd ? +(new Date(k.pd)) : null
                        ;



                    s = hashSuppliers[d.suppliers[k.s]._id] || new Supplier(d.suppliers[k.s]);
                    cs = hashCustomers[d.customers[k.c]._id] || new Customer(d.customers[k.c]);

                    k.price = parseFloat(k.p);

                    function price() {
                        return k.price;
                    }

                    data.push({
                        _id: index,
                        date: protokolDate,
                        product : k.pt,
                        parent : cs,
                        type: 0,
                        label : k.product + ' сумма ' + k.price,
                        valueOf: price
                    });

                    data.push({
                        _id: index,
                        date: signDate,
                        product : k.pt,
                        parent : s,
                        type: 1,
                        label : k.pt[0].name + ' сумма ' + k.price,
                        valueOf: price
                    });

                    publishDate && data.push({
                        _id: index,
                        date: publishDate,
                        product : k.pt,
                        parent : s,
                        type: 2,
                        label : k.pt[0].name + ' сумма ' + k.price,
                        valueOf: price
                    });
                });

                data.sort(function(a, b) {
                    return d3.ascending(a.date, b.date);
                });
            }

            d3.json('2013.gte500x10in6.json', function(err, rawData) {

                if (err) {
                    console.error(err);
                    return;
                }

                parseData(rawData);

                sizes.domain(d3.extent(data));

                var actions = L.control.actionConsole({
                    keepOpen: true,
                    position: 'topright',
                    strings: {
                        play: 'Запусить',
                        stop: 'Остановить',
                        pause: 'Приостановить',
                        repeat: 'Начать занова'
                    }
                }).addTo(map);

                visLayer.onHide = function () {
                    actions.bar.hide();
                };

                visLayer.onShow = function () {
                    actions.bar.show();
                };

                actions.buttons.pause.hide();
                actions.buttons.stop.hide();

                function stop() {
                    actions.buttons.play.hide();
                    actions.buttons.pause.hide();
                    actions.buttons.stop.hide();
                    actions.buttons.repeat.show();
                }

                var markers = new L.MarkerClusterGroup()
                    , heat = L.heatLayer([], {
                        max: 1,
                        radius: 25,
                        blur: 15,
                        gradient: {0.4: 'rgba(0, 0, 255, 1)', 0.65: 'rgba(0, 255, 0, 1)', 1: 'rgba(255, 0, 0, 1)'},
                        maxZoom: 18
                    })
                    , legend = L.categories()
                    ;

                L.control.layers({
                    'Тёманая карта': map.tileLayer, 'Светлая карта': L.mapbox.tileLayer('artzub.i1e741if'), 'OpenStreetMap': L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
                    }), 'Гуманитарная карта': L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                        maxZoom: 18,
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright" target="_blank">Участники OpenStreetMap</a>. Tiles courtesy of <a href="http://hot.openstreetmap.org/" target="_blank">Humanitarian OpenStreetMap Team</a>'
                    })
                }, {
                    'Тепловая диаграмма': heat.addTo(map),
                    'Метоки': markers.addTo(map),
                    'Динамическая визуализация': visLayer.addTo(map),
                    'Легеда': legend.addTo(map)
                }).addTo(map);

                L.control.fullscreen({position: 'bottomright'}).addTo(map);
                L.control.locate({
                    drawCircle: false,
                    position: 'bottomright',
                    strings: {
                        title: "Мое место положенние",
                        popup: "Вы в {distance} {unit} от этой точки",
                        outsideMapBoundsMsg: "Вы находится вне границ карте"
                    }
                }).addTo(map);

                var parentMarker = {}
                    , curPos = 0
                    , dateFormat = d3.time.format("<strong>%d</strong>.<strong>%m</strong>.<strong>%Y</strong>")
                    ;

                legend.legend
                        .on('mouseover', function(d) {
                            visLayer._bh.selectCategory(d);
                        })
                        .on('mouseout', function() {
                            visLayer._bh.selectCategory(null);
                        });

                function legendResize() {
                    var size = visLayer._bh.size();
                    legend.legend.size(size[0] / 3, size[1])
                            .categories(visLayer._bh.categories());
                }

                map.on('viewreset', legendResize);

                visLayer._bh
                        .on('getGroupBy', function (d) {
                            return d.date;
                        })
                        /*.on('getParent', function (d) {
                            var cont = rawData.contracts[d._id];
                            return d.type ? rawData.suppliers[cont.s] : rawData.customers[cont.c];
                        })*/
                        .on('getParentKey', function (d) {
                            return d._id;
                        })
                        .on('getChildKey', function (d) {
                            return rawData.contracts[d._id]._id;
                        })
                        .on('getCategory', function (d) {
                            return d.product[0].OKDP.name;
                        })
                        .on('getParentLabel', function (d) {
                            return d.name;
                        })
                        .on('getChildLabel', function (d) {
                            return d.label;
                        })
                        .on('calcRightBound', function (l) {
                            return l + stepDate;
                        })
                        .on('getVisibleByStep', function (d) {
                            return true;
                        })
                        .on('getCreateNearParent', function (d) {
                            return true; //d.parentNode.nodeValue instanceof Customer;
                        })
                        .on('getParentRadius', function (d) {
                            return 1;
                        })
                        .on('getChildRadius', function(d) {
                            return sizes(+d);
                        })
                        .on('getParentPosition', function (d) {
                            return [d.x, d.y];
                        })
                        .on('getParentFixed', function (d) {
                            return true;
                        })
                        .on('finished', function () {
                            stop();
                        })
                        .on('stopped', function () {
                            stop();
                        })
                        .on('starting', function () {
                        })
                        .on('started', function () {
                            legendResize();

                            yearLabel.html('');
                            visLayer._reset();
                            yearLabel.classed('parsing', false);
                            waitParse.hide();
                            actions.buttons.play.hide();
                            actions.buttons.pause.show();
                            actions.buttons.stop.show();
                            actions.buttons.repeat.hide();
                        })
                        .on('processing', function (arr, l) {
                            legend.legend.update();
                            yearLabel.html(dateFormat(new Date(l)));
                            setTimeout(setMarkers(arr), 10);
                        })
                        .on('parsing', function() {
                            yearLabel.html([
                                "<strong>",
                                curPos++,
                                "</strong>",
                                " из ",
                                data.length
                            ].join(''));
                        })
                    //.on('processed', prints)
                    //.on('mouseovernode', printm)
                    //.on('mouseoutnode', printm)
                    //.on('mousemove', printm)
                        .sort(null)
                ;

                function setMarkers(arr) {
                    return function() {
                        arr.forEach(function (d) {
                            var tp = d.parentNode.nodeValue;

                            if (!parentMarker[tp._id]) {
                                var marker = parentMarker[tp._id] = L.marker(tp.latlng, {
                                    icon: L.mapbox.marker.icon({'marker-symbol': 'commercial', 'marker-color': '222234'}),
                                    title: tp.name + "\n" + tp.address
                                });
                                marker.bindPopup(tp.name + "\n" + tp.address);
                                markers.addLayer(marker);
                            }

                            heat.addLatLng(tp.latlng);
                        });
                    }
                }

                var waitParse = actions.bar.append('a')
                    .attr('class', 'wait')
                    .on('click', function() {
                        if (d3.event) {
                            d3.event.stopPropagation();
                            d3.event.preventDefault();
                        }
                    });

                waitParse.hide = actions.buttons.play.hide.bind(waitParse);
                waitParse.show = actions.buttons.play.show.bind(waitParse);
                waitParse.hide();

                actions.buttons.play.on('click', function () {
                    if (visLayer._bh.IsPaused()) {
                        actions.buttons.pause.show();
                        actions.buttons.play.hide();
                        visLayer._bh.resume();
                    }
                    else {
                        actions.buttons.repeat.on('click')();
                    }
                });

                actions.buttons.repeat.on('click', function () {
                    curPos = 0;
                    yearLabel.classed('parsing', true);
                    waitParse.show();
                    actions.buttons.repeat.hide();
                    actions.buttons.play.hide();
                    parentMarker = {};
                    markers.clearLayers();
                    heat.setLatLngs([]);
                    visLayer.start(data);
                });

                actions.buttons.stop.on('click', function () {
                    visLayer._bh.stop();
                });

                actions.buttons.pause.on('click', function () {
                    actions.buttons.pause.hide();
                    actions.buttons.play.show();
                    visLayer._bh.pause();
                });

                actions.buttons.play.on('click')();

                d3.select(window).on("focus", function() {
                    if (window.hasOwnProperty("needPlayShow")) {
                        if (window.needPlayShow)
                            actions.buttons.play.on('click')();
                        delete window.needPlayShow;
                    }
                });

                d3.select(window).on("blur", function() {
                    if (window.hasOwnProperty("needPlayShow"))
                        return;

                    window.needPlayShow = visLayer._bh.IsRun() && !visLayer._bh.IsPaused();
                    if (window.needPlayShow)
                        actions.buttons.pause.on('click')();
                });

            });
        }
    </script>
</body>
</html>